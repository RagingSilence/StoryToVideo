# 运维与调优说明

## 日志与监控
- 网关：uvicorn access log + 应用日志；建议按 `task_id` 打印阶段时间。
- 子服务：分别记录请求/耗时/显存告警；将错误回传给网关。
- 监控：可接入 `prometheus_client` 暴露延时、QPS、失败率、队列长度；或最简用 `psutil` 记录 GPU/CPU/内存。

## 性能优化
- 文生图（SD Turbo）：fp16；`num_inference_steps` 4~8；CFG 1~2；可批量按场景并行，但注意显存。
- 图生视频（SVD Img2Vid）：降低输入分辨率（576p/720p）；控制输出帧率 10~12fps；必要时单任务串行。
- TTS：预热模型；批量合成；缓存声学模型到内存/磁盘。
- ffmpeg：统一采样率/声道避免重复转码；可启用 `-hwaccel cuda` 加速。
- IO：使用本地 NVMe；若接对象存储，可在节点本地做缓存后批量上传。

## 常见问题
- 显存不足：降低分辨率/步数/批量，或划分多卡；确保关闭多余进程。
- 推理耗时过长：减少场景数、步数、帧率；调整任务队列并发。
- 颜色/风格不一致：在分镜 prompt 中加入统一风格标签；将 seed 固定。
- 音画不同步：ffmpeg 合成前统一 fps 和音频采样率；合成时使用 `-shortest`。
- 文件路径冲突：使用 task_id/uuid 命名；避免覆盖旧文件。
- FRP 无法访问：检查 token/端口、防火墙；确认 frpc 与网关在同一主机网络。

## 安全与鉴权
- 内网可裸跑；公网暴露建议：HTTPS 反向代理 + 简单 API Key（Header `X-API-Key`），或 JWT。
- 控制输出目录白名单，避免任意路径读写。
- 对推理接口设置并发/队列上限，防止 DoS。

## 备份与清理
- 关键目录：`data/`（产出）、`logs/`（如有）、模型缓存（HuggingFace、Ollama、CosyVoice）。
- 定期清理：过期任务产出、临时文件；可用 cron 删除 N 天前的 `frames/`、`clips/`。
- 版本管理：脚本/配置纳入 git；生成的模型文件可不入库，使用 `.gitignore`。

## 升级与回滚
- 依赖升级前在测试环境验证模型输出一致性。
- 对网关与服务做版本号标记，滚动升级；若异常快速回滚镜像/commit。
- 变更接口时在 `docs/apis.md` 同步示例与字段描述。
